<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scaleable=no">
    <title>Integrated Forecast (STATIC) - Applebee's C8 Pasta & Grill Combos - Q3 '19 </title>
    <script src="//media.admob.com/api/v1/google_mobile_app_ads.js"></script>

    <script>
    var labAd = {
      adCond: null,
      mode: null,
    //  testinglocal: false,
      meta:{
        advertiser: 'Applebees C8 Pasta & Grill Combos',            // Ex: 'mcdonalds'
				placement: 'ID255452468',      // Ex: 'ros-shopper-moms'
				platform: 'all',                           // 'ios', 'android', 'web', 'mw', or 'all'
        product: 'IF - Integrated Forecast',
				type: 'IF-3.0',
        width: 360,
				height: 260,
        created: '09-30-2019',                     // Ex: '08-23-2018'
        modified: '',
        design: 'Marty',                           // Ex: 'coreyd'
        dev: 'JamesB'                                 // Ex: 'dks'
      },
      appBg: { // object passed to AppEvent - do not add new properties to this object.
        baseURL: '',
        imgID: '', // Ex: '414x210-McDonalds@1x.jpg'
        displayMode: ''
      },
      appBgVid: { // object passed to AppEvent - do not add new properties to this object.
        vidURL: '', // Ex:'414x210-clear_day@1x.mp4' - @1x filename only for initial assignment. labAd.dir prepended before sending to app event.
        vidLogicalHeight: 510,
        vidLogicalWidth: 400,
        displayMode: '' // or DARK TEXT = darkText
        //Display Mode will be different depeneind gon weather condtion
      },
      deviceSize:'sm', // sm, md, lg, xl
      // dir: 'https://s.w-x.co/ads/creatives/im/gridlines/',
      dir: 'https://s.w-x.co/cl/applebees/if-cl1886-stc/', // // HACK: dev only - not for production
      dpr: window.devicePixelRatio,
      default: {
        cnd: 'cld',
        dynght: 'D',
        img:'', // Ex: 320x260-subway-all-day@1x.png
        previewMode: 'o',
        reason:'na' // 'na' is default
      },
      displayed: false, // flag indicating showAd or showDefault has executed successfully.
      selected: {        // for tracking selected values
        adImages:[],
        bgEvent:'adBgIntF', // Ex: 'adBg' or 'adBgVid' - set based on ad concept.
        scenario: 'na'
      },
      els: {},
      errors: [],
      imgs: {},
      log: logInfo,
      logLevel: 1, // 0 = none, 1 = labAd, 2 = everything
      logs: [],
      mp:{ // mixpanel
				evt: {}, // container for most recent mp event object
				log: [],
				prefix:'https://api.mixpanel.com/track/?data=',
				token:'8a31c468d87c9e0e921441f60a7e64db',
				verbose: 0 // NOTE: value should be 0 in production. 1 for dev diagnostics
			},
      macros: { // macros populated by GAM when ad is served
        cnd: "%%PATTERN:cnd%%", // current condition.
        dynght: "%%PATTERN:dynght%%", // day or night? Possible values: 'D', 'N'
        height: "%%HEIGHT%%", // ad slot height
        plat: "%%PATTERN:plat%%", // platform. Used for tracking
        timeframe: "%%PATTERN:tf%%", // timeframe. Used for tracking
        gamClick: "%%CLICK_URL_UNESC%%", // Google Ad Manager click track URL
        gamPreview: '%%PREVIEW_MODE%%',
        cid: "%ecid!", // creative id
        lid: "%eaid!", // line item id
        ord: '%%CACHEBUSTER%%'
      },

      //Need to swap this out with IF UI //
      preview:{
        css:{id:'previewCSS', href:'preview.css', dir:'standard'},
        dirs:{
          standard:'https://s.w-x.co/cl/if/apps/preview-mode/standard/',
          white:'https://s.w-x.co/cl/if/apps/preview-mode/whitetxt/',
          dark:'https://s.w-x.co/cl/if/apps/preview-mode/darktxt/',
          custom:'https://s.w-x.co/cl/if/gridlines/'
        },
        images:[
          // NOTE: images.src values use split('-'). Extraneous '-' in filenames will cause issues.
          // Standard Preview Images & Conditions
          {id:'logo', src:'all-logo-watson-ads.png', dir:'standard'},
          {id:'device', src:'lg-device.png', dir:'standard'},
          {id:'ui-clr+D', src:'lg-ui-clear-day.png', dir:'white'},
          {id:'ui-clr+N', src:'lg-ui-clear-night.png', dir:'white'},
          {id:'ui-cld+D', src:'lg-ui-cloudy-day.png', dir:'white'},
          {id:'ui-cld+N', src:'lg-ui-cloudy-night.png', dir:'white'},
          {id:'ui-rain+D', src:'lg-ui-rainy-day.png', dir:'white'},
          {id:'ui-rain+N', src:'lg-ui-rainy-night.png', dir:'white'},
          {id:'ui-snow+D', src:'lg-ui-wintry-day.png', dir:'white'},
          {id:'ui-snow+N', src:'lg-ui-wintry-night.png', dir:'white'}
        ]
      },
      test: {},
			time: {
				log:{},
				stamp:0 // most recent getTime. Updated when logTime is called.
			},
      tracking: {
        clickTag: 'https://ad.doubleclick.net/ddm/trackclk/N9522.268IBM/B23219864.255452468;dc_trk_aid=451920417;dc_trk_cid=121739871;dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua=',   // Clicktag
        imp3rdParty: 'https://ad.doubleclick.net/ddm/trackimp/N9522.268IBM/B23219864.255452468;dc_trk_aid=451920417;dc_trk_cid=121739871;ord=%%CACHEBUSTER%%;dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua=?',
        placedpxl:'https://p.placed.com/api/v2/sync/impression?partner=weather&version=1.0&plaid=a919ininy-appbc8pgc&payload_campaign_identifier=%eaid!&payload_device_identifier=%%ADVERTISING_IDENTIFIER_PLAIN%%&payload_timestamp=%%CACHEBUSTER%%&payload_type=impression' // IMP2

      }
    }

    function initAd() {
			try {
        // init date & time
        labAd.time.date = new Date();
        logTime('initAd');

				// init labAd props and els - especially those needed for tracking and timing operations
				labAd.els.labAdDiv = document.getElementById('labAdDiv');
				labAd.els.labTracking = document.getElementById('labTracking');

        // request overall tracking. The true argument indicates mixpanel pixel will be requested at the same time.
				getImpPixel(labAd.tracking.imp3rdParty, 'imp-3rdParty', false);
        getImpPixel(labAd.tracking.placedpxl, 'placed-pxl', false);

        // fire adIntF event asap so the app knows to push the feed card down
        fireAppEvent('adIntF', {});

				// get ad mode to determine if vars populated by macros or test hash
				labAd.mode = getAdMode();

        // populate vars from the correct source for mode
        initAdMode(labAd.mode);

        // determine adCond based on cnd and dynght values
        labAd.adCond = labAd.macros.cnd + '-' + labAd.macros.dynght;

        // if Preview Mode, load external js & css
        if (labAd.mode === 'preview' || labAd.mode === 'gamPreview') {
          // load resources needed for Preview Mode, then init Preview Mode.
          getPreviewResources();
        }else{ // else proceed to display using ad served
          initDisplay(labAd.adCond);
        }

			} catch (err) {
        labAd.log({label: 'initAd error: ', detail: err, type: 'error', isFatal: true });
			}
		}

    function initAdMode(sMode){
      try {
        var result = '';
        // Cases below should define adjustments needed for test modes supported by ad.
				switch (sMode) {
					case 'preview':
          case 'gamPreview':
            // clear GAM click macro so clicks will work in test modes
						labAd.macros.gamClick = "";
            // assign values from HashParts - hash order is adstest + cnd + dynght + deviceSize + DPR + previewMode
            labAd.macros.cnd = labAd.test.HashParts[1];
						labAd.macros.dynght = labAd.test.HashParts[2].toUpperCase();
						labAd.deviceSize = labAd.test.HashParts[3].toLowerCase();

            // get dpr from hash if not undefined, otherwise use window property
            labAd.dpr = (labAd.test.HashParts[4] != undefined) ? Number(labAd.test.HashParts[4]) : window.devicePixelRatio;

						// adjust meta height to keep mixpanel data accurate
            if (labAd.deviceSize !== 'sm') {
              labAd.meta.height = 320; // adjust meta height to keep mixpanel data accurate
            }
						break;
					default: // covers 'live' and 'none'
						labAd.deviceSize = getDeviceSize();
						break;
				}

        // log result
        result = labAd.mode + ' activated';
        labAd.log({label: 'initAdMode ', detail: result, type: 'log' });
      } catch (err) {
        labAd.log({label: 'initAdMode error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function initDisplay(sCond){
      logTime('initDisplay');
      try {
        // start the display routine by firing appEvent, selecting files, loading AD & BG images

        // fire adIM event asap so the app knows to push the feed card down
        fireAppEvent('adIntF', {});

        // select files needed for AD & BG display.
        labAd.selected = fileSelection(sCond);

        // 1: showBg - pass selected BG event name. BG should be called first since it cannot be preloaded. //
        showBg(labAd.selected.bgEvent);

        // 2: preload AD images as a batch. Calls showAd or showDefault depending on success or failure. //
        loadAdImages('adImages', labAd.selected.adImages, 3000 );
        // Required arguments are: batchName, array of image objects and max load time in ms.

        labAd.log({label: 'initDisplay ', detail: sCond, type: 'log' });
      } catch (err) {
        labAd.log({label: 'initDisplay error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function exitClick(event) {
      try {
        event.preventDefault();
        var id = event.target.id;
        var url = labAd.tracking.clickTag;
        var target = "_blank";
        var clickTime = logTime('exitClick');
        var btnPos = labAd.els.btnInv.getBoundingClientRect();
        labAd.log({label: 'exitClick from: ' + id, detail: url, type: 'log' });
        // track in mixPanel
				var trackObj = {
					adCond: labAd.adCond,
					adMode: labAd.mode,
					targetId: id,
					destURL: url,
					// use client values minus btnPos to get true offset from top left of clickable region
					clientX: event.clientX - btnPos.x,
					clientY: event.clientY - btnPos.y,
          timeElapsed:(clickTime - labAd.time.log['initAd'].stamp)
				};

				mixpanelTrack('clk-exitClick', 'click', trackObj);
        // launch clickthrough window
         window.open(labAd.macros.gamClick + url, target);
      //  alert(JSON.stringify(labAd, null, 1)); // HACK: remove from final code
      } catch (err) {
        labAd.log({label: 'exitClick error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function fileSelection(sCond){
      try {
        // return array of AD images to be loaded, BG event name and a string describing the logical choice.
        var selected = {adImages:[], bgEvent:'adBgIntF', scenario: ''};

        /////////////////////////////////////////////////////////
        // 1: Assign values used for most or all scenarios //
        /////////////////////////////////////////////////////////
        // NOTE: this can be the only AD image for IMs with all content in the BG
        selected.adImages.push( imgObj('btnInv', 'https://s.w-x.co/cl/IntgFrcst/test/320x260-gridlines@1x.png') );
        selected.bgEvent = 'adBgIntF';

        //////////////////////////////////////////////
        // 2: Assign BG image/video to appBg or appBgVid //
        //////////////////////////////////////////////
      //  selected.scenario = 'Test Creative - no variants';
      //  selected.previewUI = '';
      //  labAd.appBg.imgID = setSrcSize('414x200-v2-gridlines@1x.jpg');


        switch (sCond) { // NOTE: switch cases below covers conditions covered by old AppBG
          case 'clr-D':
          case 'sun-D'://Clear Day - should never occur. // REVIEW: monitor via mixpanel after live and possible remove later.
            selected.previewUI = 'Clear Day - Image';
            labAd.appBg.imgID = setSrcSize('400x510-applebees-day-clear@1x.jpg');
            //selected.adImages.push( imgObj('fg-text', '320x260-subway-all-day@1x.png') );
            labAd.appBg.displayMode = 'whiteText';
            break;
          case 'clr-N':
          case 'sun-N'://Clear Night
            selected.previewUI = 'Clear Night - Image';
            labAd.appBg.imgID = setSrcSize('400x510-applebees-night-clear@1x.jpg');
            //selected.adImages.push( imgObj('fg-text', '320x260-subway-all-night@1x.png') );
            labAd.appBg.displayMode = 'whiteText';
            break;
          case 'cld-D'://Cloudy Day
          case 'pcld-D'://Cloudy Day
            selected.previewUI = 'Cloudy Day - Image';
            labAd.appBg.imgID = setSrcSize('400x510-applebees-day-cloudy@1x.jpg');
            //selected.adImages.push( imgObj('fg-text', '320x260-subway-all-day@1x.png') );
            labAd.appBg.displayMode = 'whiteText';
            break;
          case 'cld-N'://Cloudy Night
          case 'pcld-N'://Cloudy Night
            selected.previewUI = 'Cloudy Night - Image';
            labAd.appBg.imgID = setSrcSize('400x510-applebees-night-cloudy@1x.jpg');
            //selected.adImages.push( imgObj('fg-text', '320x260-subway-all-night@1x.png') );
            labAd.appBg.displayMode = 'whiteText';
            break;
          case 'rain-D'://Rainy Day
          case 'thdr-D':
            selected.previewUI = 'Rainy/Stormy Day - Image';
            labAd.appBg.imgID = setSrcSize('400x510-applebees-day-rainy@1x.jpg');
            //selected.adImages.push( imgObj('fg-text', '320x260-subway-all-day@1x.png') );
            labAd.appBg.displayMode = 'whiteText';
            break;
          case 'rain-N':
          case 'thdr-N'://Rainy Night
            selected.previewUI = 'Rainy/Stormy Night - Image';
            labAd.appBg.imgID = setSrcSize('400x510-applebees-night-rainy@1x.jpg');
            //selected.adImages.push( imgObj('fg-text', '320x260-subway-all-night@1x.png') );
            labAd.appBg.displayMode = 'whiteText';
            break;

          case 'snow-D'://Wintry Day
            selected.previewUI = 'Wintry/Icy Day - Image';
            labAd.appBg.imgID = setSrcSize('400x510-applebees-day-wintry@1x.jpg');
            //selected.adImages.push( imgObj('fg-text', '320x260-subway-all-day@1x.png') );
            labAd.appBg.displayMode = 'whiteText';
            break;

          case 'snow-N'://Wintry Night
            selected.previewUI = 'Wintry/Icy Night - Image';
            labAd.appBg.imgID = setSrcSize('400x510-applebees-night-wintry@1x.jpg');
            //selected.adImages.push( imgObj('fg-text', '320x260-subway-all-night@1x.png') );
            labAd.appBg.displayMode = 'whiteText';
            break;

          default: // NOTE: also assigning clear day video as the default case if any unexpected conditions occur.
            selected.previewUI = 'Default Condition Image '+ sCond;
            labAd.appBg.imgID = setSrcSize('400x510-applebees-day-cloudy@1x.jpg');
            //selected.adImages.push( imgObj('fg-text', '320x260-subway-all-day@1x.png') );
            labAd.appBg.displayMode = 'whiteText';
            break;
        }



        // log results
        labAd.log({label: 'fileSelection ', detail: selected, type: 'log' });

        ///////////////////////////////////
        // 4: return object with details //
        ///////////////////////////////////
        return selected;
      } catch (err) {
        labAd.log({label: 'fileSelection error: ', detail: err, type: 'error', isFatal: true });
      }
    }

    function fireAppEvent(sEventName, oProps) {
      try {
        logTime('fireAppEvent-'+ sEventName);
        // stringify oProps object for use in dispatchAppEvent
        var payload = JSON.stringify(oProps);
        admob.events.dispatchAppEvent(sEventName, payload);

        labAd.log({label: 'fireAppEvent ' + sEventName, detail: oProps, type: 'log' });
      } catch (err) {
        labAd.log({label: 'fireAppEvent error: '+ sEventName, detail: err, type: 'error', isFatal: false });
      }
    }

    function getImpPixel(sURL, sEventName, trackInMixpanel) {
			try {
				var regexp = /(https?:\/\/[^\s]+)/g; // begins with http:// or https://
				if (regexp.exec(sURL)) {
					// if url is valid, add tracking pixel to labTracking
					var pixel = document.createElement('img');
					pixel.src = sURL;
					pixel.alt = sEventName;
					// add new img to tracking div
					labAd.els.labTracking.appendChild(pixel);

          // if flagged for mixpanel, append '-mixpanel' to sEventName and track in mixpanel
					if (trackInMixpanel) {
						mixpanelTrack(sEventName + '-mixpanel', 'imp', {trackSrc:pixel.src});
					}

					// log success
					labAd.log({label: 'getImpPixel: ' + sEventName, detail: pixel, type: 'log' });
				} else {
					// log error for invalid URL.
					var eO = {message:'sEventName: ' + sEventName};
          labAd.log({label: 'getImpPixel - invalid URL: ' + sURL, detail: eO, type: 'error', isFatal: false });
				}
			} catch (err) {
        labAd.log({label: 'getImpPixel error: ', detail: err, type: 'error', isFatal: false });
			}
		}

    function getAdMode() {
			try {
        labAd.test.HashParts = getTestHash();
				// if the zero index === adstest, we go into test mode
				if (labAd.test.HashParts[0] === "adstest") {
            labAd.test.mode = 'preview';
				} else if (labAd.macros.gamPreview === 'true') { // Macro will return true for GAM Creative Preview. Original macro token will be intact during local dev.
            labAd.test.mode = 'gamPreview';
				} else if (labAd.macros.cid.indexOf('ecid') === -1) { // Macro will replace 'ecid' with creative id string indicating ad has been served by GAM.
            labAd.test.mode = 'live';
				} else {
            labAd.test.mode = 'none';
				}

				labAd.log({label: 'getAdMode: ' + labAd.test.mode, detail: labAd.test, type: 'log' });
				return labAd.test.mode;
			} catch (err) {
        labAd.log({label: 'getAdMode error: ', detail: err, type: 'error', isFatal: true });
			}
		}

    function getDeviceSize(){
      try {
        // return a value for labAd.deviceSize based on height of ad slot
        // the code is served into. For IF-betaHack, we know the height will be "320"
        // for larger devices.
        var sz = 'sm'; // always defaults to small
        if (labAd.macros.height === '320') {
          sz = 'lg';
          labAd.meta.height = 320; // adjust meta height to keep mixpanel data accurate
        }

        labAd.log({label: 'getDeviceSize ', detail: sz, type: 'log' });
        return sz;
      } catch (err) {
        labAd.log({label: 'getDeviceSize error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function getPreviewResources(){
      try {
        // register loader method, then create Promise to load resource files
        // and init Preview Mode when resolved.
        labAd.preview.loadResources = (function() {
          // Function which returns a function: https://davidwalsh.name/javascript-functions
          function _load(tag) {
            return function(url) {
              // This promise will be used by Promise.all to determine success or failure
              return new Promise(function(resolve, reject) {
                var element = document.createElement(tag);
                var parent = 'body';
                var attr = 'src';

                // Important success and error for the promise
                element.onload = function() {
                  resolve(url);
                };
                element.onerror = function(err) {
                  reject(err);
                };

                // Need to set different attributes depending on tag type
                switch(tag) {
                  case 'script':
                    element.async = true;
                    break;
                  case 'link':
                    element.type = 'text/css';
                    element.rel = 'stylesheet';
                    attr = 'href';
                    parent = 'head';
                }

                // Inject into document to kick off loading
                element[attr] = url;
                document[parent].appendChild(element);
              });
            };
          }

          return {
            css: _load('link'),
            js: _load('script'),
            img: _load('img')
          }
        })();


        // JAMES TEST //
        var previewjscos = labAd.preview.loadResources.js(labAd.preview.dirs['standard'] +'preview.js');
        var previewcsscos = labAd.preview.loadResources.css(labAd.preview.dirs[labAd.preview.css.dir] + labAd.preview.css.href);

      //  var previewjsloc = labAd.preview.loadResources.js('preview.js');
      //  var previewcssloc = labAd.preview.loadResources.css('preview.css');

        ////////////////


        // register Promise to load resources and execute based on success or failure
        labAd.preview.prom = Promise.all([


          previewjscos, previewcsscos
        //  labAd.preview.loadResources.js(labAd.preview.dirs['standard'] +'preview.js'),
        //  labAd.preview.loadResources.css(labAd.preview.dirs[labAd.preview.css.dir] + labAd.preview.css.href)


          //UNLOCK THIS TO TEST PREVIEW JS&CSS LOCALLY //
          //////////
          //     labAd.preview.loadResources.js('preview.js'),
          //     labAd.preview.loadResources.css('preview.css')




        ]).then(function(result) {
          labAd.log({label: 'Preview Mode files loaded. ', detail: result, type: 'log' });
          labAd.preview.init();
        }).catch(function(err) {
          labAd.log({label: 'Preview Mode file load error: ', detail: err, type: 'error', isFatal: true });
        });

        labAd.log({label: 'getPreviewResources ', detail: 'getPreviewResources', type: 'log' });
      } catch (err) {
        labAd.log({label: 'getPreviewResources error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function getTestHash(){
      try {
        // expected format & order #adstest + cnd + dynght + deviceSize + dpr
				labAd.test.hashStr = top.window.location.hash.substring(1);
				// if this is a local file or gamPreview ith no adstest hash, assign default
				// hashStr value to eliminate need to manually add it to url
        if ((top.window.location.protocol === 'file:' || labAd.macros.gamPreview === 'true') && labAd.test.hashStr.indexOf('adstest') == -1) {
          // get actual deviceSize based on macro value to use as defualt
          labAd.deviceSize = getDeviceSize();
          // build array of default values mapped to labAd props so changes are automatically picked up here
          labAd.test.defaultHashParts = ['adstest', labAd.default.cnd, labAd.default.dynght, labAd.deviceSize, labAd.dpr, labAd.default.previewMode,];
          // set the missing hash by joining parts of this array to assemble default adstest hash string
          top.window.location.hash = labAd.test.defaultHashParts.join('+');
          // now get and use the hashtring
          labAd.test.hashStr = top.window.location.hash.substring(1);
          labAd.log({label: 'getTestHash defaultHashParts', detail: labAd.test.defaultHashParts, type: 'log' });
        }
        // split hash string on '+' delimiter
				labAd.test.hashArray = labAd.test.hashStr.split("+");
        // validate by filtering out empty values: "", undefined
        labAd.test.hashArrayFiltered = labAd.test.hashArray.filter(function (el) {
          return el != null && el != "";
        });

        labAd.log({label: 'getTestHash ', detail: labAd.test.hashArrayFiltered, type: 'log' });
        // return validated and sanitized array of #adstest hash values
        return labAd.test.hashArrayFiltered;
      } catch (err) {
        labAd.log({label: 'getTestHash error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function imgBatchLoad(imgBatch){
				try {
		      // store latest batch in labAd.imgs and add additional loader properties
					labAd.imgs[imgBatch.name] = {
						cb: imgBatch.cbSuccess,
						cbFail: imgBatch.cbFail,
						cbFailFired: false,			// flag to ensure callback only fires once if multiple failures in batch
						loadCount: 0,
						loadTimer: 0,
						loadTimeMax: imgBatch.maxLoadTime,
						loaded: [],
						toLoad: imgBatch.imgs
					};
					// start timer for max allowed time for ALL images in batch to load
					labAd.imgs[imgBatch.name].loadTimer = setTimeout(function() {
						var eO = {message:labAd.imgs[imgBatch.name].loadTimeMax + 'ms max load time exceeded.'};
            labAd.log({label: 'imgBatchLoad timeout: '+ imgBatch.name + ' - ', detail: eO, type: 'error', isFatal: false });
						// set reason and show static default
						labAd.default.reason = 'imgBatchLoad - '+ imgBatch.name + '- max load time exceeded';
						if (!labAd.imgs[imgBatch.name].cbFailFired) {
							labAd.imgs[imgBatch.name].cbFailFired = true; // set flag so cbFail can only fire once per batch
							labAd.imgs[imgBatch.name].cbFail(labAd.default.reason);         // execute failure callback
						}
					}, labAd.imgs[imgBatch.name].loadTimeMax);

					// load each img with load and error handlers
          for (var i = 0; i < imgBatch.imgs.length; i++) {
              var imgObj = new Image();
              imgObj.id = imgBatch.imgs[i].id; // apply id assigned by imgObj step. This used for JS/CSS hook when img added to DOM in showAd.
              if (imgBatch.imgs[i].src.indexOf("://") == -1) { // prepend dir when its only the img name
                  imgObj.src = labAd.dir + imgBatch.imgs[i].src;
              } else { // use full path
                  imgObj.src = imgBatch.imgs[i].src;
              }
              imgObj.onload = function(){
								labAd.imgs[imgBatch.name].loadCount++;
								labAd.imgs[imgBatch.name].loaded.push(this);
								if (labAd.imgs[imgBatch.name].loadCount === labAd.imgs[imgBatch.name].toLoad.length) { // if all imgs loaded
									clearInterval(labAd.imgs[imgBatch.name].loadTimer);
                  labAd.log({label: 'imgBatchLoad complete: '+ imgBatch.name, detail: labAd.imgs[imgBatch.name], type: 'log' });
                  // check flag to make sure showDefault hasnt already been called
									labAd.imgs[imgBatch.name].cb(labAd.imgs[imgBatch.name].loaded); // execute callback function - pass array of loaded images
								}
							};
              imgObj.onerror = function(err){
								clearInterval(labAd.imgs[imgBatch.name].loadTimer);
                labAd.log({label: 'imgBatchLoad - '+ imgBatch.name + ' - error: ' + err.target.src, detail: err, type: 'error', isFatal: false });
								// set reason and show static default
								labAd.default.reason = 'imgBatchLoad - '+ imgBatch.name + ' - error: ' + err.target.src;
								if (!labAd.imgs[imgBatch.name].cbFailFired) {
									labAd.imgs[imgBatch.name].cbFailFired = true; // set flag so cbFail can only fire once
									labAd.imgs[imgBatch.name].cbFail(labAd.default.reason);         // execute failure callback
								}
							};
          }
				} catch (err) {
            labAd.log({label:'imgBatchLoad error on batch: '+ imgBatch.name +' - ', detail: err, type: 'error', isFatal: true });
				}
		}

    function imgDPR(sFilename) {
			try {
        // apply img name based on devicePixelRatio (or argument representing dpr)
        // assuming all base filenames should contain '@1x'
        var imgName = decodeURIComponent(sFilename);
        var adjusted = 'not adjusted.';

        if (imgName.indexOf('@') != -1) { // if decoded filename contains @ symbol
          // make DPR adjustments using string replacement
          if (labAd.dpr > 2) {
            // triple density
            imgName = imgName.replace('@1x', '@3x');
            adjusted = 'adjusted to 3x.';
          } else if (labAd.dpr > 1 && labAd.dpr <= 2) {
            // double density aka retina
            imgName = imgName.replace('@1x', '@2x');
            adjusted = 'adjusted to 2x.';
          } else {
            // no adjustment required since default is '@1x'
          }
					// log success
					// labAd.log({label: 'imgDPR: '+ adjusted, detail: imgName, type: 'log' });
				} else {
					// warn in console for files missing @ symbol
					adjusted = '@ symbol not found in filename so imgDPR adjustment is not possible.'
					labAd.log({label: 'imgDPR: '+ adjusted, detail: imgName, type: 'warn' });
				}

        return imgName;
			} catch (err) {
        labAd.log({label: 'imgDPR error: ', detail: err, type: 'error', isFatal: false });
			}
		}

    function imgObj(sId, sSrc){
      try {
        var obj = {id: sId, src: imgDPR(sSrc)};
        // adjust image size of src
        obj.src = setSrcSize(obj.src);
        // log results
        labAd.log({label: 'imgObj '+ sId + ' - ' + sSrc, detail: obj, type: 'log' });
        return obj;
      } catch (err) {
        labAd.log({label: 'imgObj error: ', detail: err, type: 'error', isFatal: true });
      }
    }

    function loadAdImages(sBatchName, aImages, nMaxLoadTime){
      try {
        // make sure there's at least one image object to load
        if (aImages.length >= 1) {
          // create batch loading object defining what to load, now long to wait and what to do on success/failure.
          var imgBatch = {
            name: sBatchName,         // label this batch of imgs. Use camelCase. Avoid dashes, dots, etc.
            imgs: aImages,            // array of img names
            maxLoadTime: nMaxLoadTime,// how long to wait for everything to load
            cbSuccess:showAd ,        // callback function to execute once everything loads
    //        cbSuccess: function(){ setTimeout(showAd, 750); },        // callback function to execute once everything loads
            cbFail: showDefault       // callback function to execute on timeout or error
          };
          // start loading the batch
          imgBatchLoad(imgBatch);
          labAd.log({label: 'loadAdImages ', detail: imgBatch, type: 'log' });
        } else {
          alert('Integrated Marquee Ads must have at least 1 image in the AD Area.\n\nMake sure aImages array (2nd argument) has at least 1 entry.\n\nUse transparent .png if all content is in the BG file.');
          labAd.log({label: 'loadAdImages error: ', detail: {message:'aImages array is empty.'}, type: 'error', isFatal: true });
        }
      } catch (err) {
        labAd.log({label: 'loadAdImages error: ', detail: err, type: 'error', isFatal: true });
      }
    }

    function logInfo(oInfo){
      // save to logs array - regardless of type or details
      this.logs.push(oInfo);

      // console output format will correspond to type of info being logged.
      // only local files are eligible for console output.

      // steps for error logs
      if (oInfo.type === 'error') {
        // save to errors array
        this.errors.push(oInfo);
        // always output log errors so they cannot be suppressed/missed due to logLevel
        console[oInfo.type](oInfo);

        // track in mixpanel
				var trackObj = {
					adCond: labAd.adCond,
					isFatal: oInfo.isFatal,
          source: oInfo.label,
					message: oInfo.detail.message
				};
				mixpanelTrack('err-logError', 'err', trackObj);

        // if the error is fatal, call showDefault with label passed as reason
        if (oInfo.isFatal) {
          showDefault(oInfo.label);
        }
      }else{ // steps for non-error logs

        // console output is only possible if file is local
        if (window.location.href.indexOf("file://") != -1) {
          // adjust type/level of output based on labAd.logLevel
          switch (labAd.logLevel) {
            case 2:
              // output every individual log
              console[oInfo.type](oInfo);
              break;
            case 0:
              // output nothing to console
              break;
            default:
              // clear console since this can fire many times but we only need 1 output for this setting
              console.clear();

              // if there are errors, output them before labAd
              if (labAd.errors.length > 0) {
                labAd.errors.forEach(function(err, i){
                  console.error(err);
                })
              }

              // output labAd object for easy inspection
              console.log(labAd);
          }
        };
      }

      // update labInfo. Example: statefarm-4693437107-1528401281492
      setLabInfo(this.meta.advertiser + '-' + this.meta.placement + '-' + this.meta.width + 'x' + this.meta.height + '-' + this.time.date, this);
    }

    function logTime(sName){
				try {
		      // log timing of key events to time.log for tracking purposes
					// also return getTime() value so this can be used to get timestamps
					var d = new Date();
					var order = Object.keys(labAd.time.log).length;
					// create new log obj
					labAd.time.log[sName] = {};
					// stamp this event
					labAd.time.log[sName].stamp = d.getTime();
					// calc split in ms from previous stamp
          if (sName != 'initAd') {
            labAd.time.log[sName].split = (labAd.time.log[sName].stamp - labAd.time.stamp);
          } else {
            labAd.time.log[sName].split = 0;
          }
					// calc elapsed from initAd - in ms
					labAd.time.log[sName].elapsed = (labAd.time.log[sName].stamp - labAd.time.log['initAd'].stamp);
					// capture log order to indicate where in sequence this log occured
					labAd.time.log[sName].order = order;

					// capture timestamp to use for next split
					labAd.time.stamp = d.getTime();

					return labAd.time.stamp;
				} catch (err) {
          labAd.log({label: 'logTime error: ', detail: err, type: 'error', isFatal: false });
				}
		}

    function mixpanelEncode(str){
			// base64EncodeUnicode from https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding
			return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
	        function toSolidBytes(match, p1) {
	            return String.fromCharCode('0x' + p1);
	    }));
		}

    function mixpanelTimingReport(){
				try {
		      // function to sort time.log and report to mixpanel
					var trackObj = {
						adCond: labAd.adCond
					};

					// iterate labAd.time.log and add each key to trackObj
					for (var key in labAd.time.log) {
						if (labAd.time.log.hasOwnProperty(key)) {
							if (key.indexOf('-') == -1) { // ignore any keys with dashes - those are mp tracking
								var newKey = key.charAt(0).toUpperCase() + key.slice(1);
								trackObj[key + 'Elapsed'] = labAd.time.log[key].elapsed;
								trackObj[key + 'Split'] = labAd.time.log[key].split;
							}
						}
					}

					// track in mixpanel
					mixpanelTrack('lab-mixpanelTimingReport', 'lab', trackObj);
          // labAd.log({label: 'mixpanelTimingReport: ', detail: trackObj, type: 'log' });
				} catch (err) {
          labAd.log({label: 'mixpanelTimingReport error: ', detail: err, type: 'error', isFatal: false });
				}
		}

    function mixpanelTrack(sEventName, sEventType, oProps){
				try {
					labAd.mp.evt = { // standard mixpanel event obj
						'event': sEventName,
				    'properties': {
								'adCond': '', // blank prior to ad logic init. Then passed by each event
								'cid': labAd.macros.cid,
								'eventType': sEventType,
								'placement': labAd.meta.placement + labAd.meta.width + 'x' + labAd.meta.height,
								'platform': labAd.macros.plat,
                'timeframe': labAd.macros.timeframe,
								'time': labAd.time.date.getTime(), // timestamp for ad served time
								'timestamp': logTime('mp-'+sEventName), // timestamp for event tracked time
								'testMode': labAd.mode,
				        'token': labAd.mp.token // NOTE: token is mixpanel reserved prop name
				    }
					}

					// modify mixpanel cid property whenever mode != 'live'.
					// This will make it possible to sort by mode in mixpanel
					// and ensure that only ad-served imps have number-string cids.
					if (labAd.mode != 'live') {
						labAd.mp.evt.properties.cid = labAd.mode+'-'+labAd.mp.evt.properties.placement;
					}

					// Use oProps to add prefixed props unique to the event. Example: errMessage
					for (var key in oProps) {
						if (oProps.hasOwnProperty(key)) {
							if (key === 'adCond') { // add adCond without prefix
								labAd.mp.evt.properties.adCond = oProps[key];
							} else { // add with event type prefix
								// capitalize first char of key to maintain camelCase
								var newKey = key.charAt(0).toUpperCase() + key.slice(1);
								labAd.mp.evt.properties[sEventType + newKey] = oProps[key];
							}
						}
					}

					// stringify object, then b64Encode
					var strData = JSON.stringify(labAd.mp.evt, null, 2);
					var data = mixpanelEncode(strData);
					// construct url. img=1 causes mixpanel to respond with 1x1
					var sURL = labAd.mp.prefix + data + '=&img=1&verbose=' + labAd.mp.verbose;
					// store event to mixpanel log
					labAd.mp.log.push(labAd.mp.evt);

					// adjust sEventName values to result in more decscriptive alt vals on labTracking pixels. Does not impact mixpanel since data has already been sent.
					if (sEventType === 'err') {
						sEventName += ': ' + labAd.mp.evt.properties['errSource'] +' - '+ labAd.mp.evt.properties['errMessage'];
					}

					// only request mixpanel pixel if NOT in GAM preview.
					// GAM preview populates CID which makes it appear as 'ad served' - even though GAM doesnt count.
					if (labAd.mode != 'gamPreview') {
						// getImpPixel(sURL, sEventName);
					}

					// mixpanelTimingReport if sEventName is imp-showAd or imp-showDefault. This should ensure it only fires once per impression
					if (sEventName === 'imp-showAd' || sEventName === 'imp-showDefault') {
						//mixpanelTimingReport(); // send all logTime data to mixpanel
					}

				} catch (err) {
            labAd.log({label: 'mixpanelTrack error: ', detail: err, type: 'error', isFatal: false });
				}
		}

    function setLabInfo(sName, obj) {
			try {
				// store passed object to labInfo on parent DOM if possible
				if (labAd.macros.gamPreview === 'true') {
					// skip logging if running in DFP Preview
					return;
				} else {
					parent.labInfo = parent.labInfo || {};
					parent.labInfo[sName] = obj;
				}
			} catch (err) {
        labAd.log({label: 'setLabInfo error: ', detail: err, type: 'error', isFatal: false });
			}
		}

    function setSrcSize(sFilename) {
			try {
        // perform string replacement to adjust from sm to lg image
        var imgName = decodeURIComponent(sFilename);
        var adjusted = 'not adjusted.';

        if (labAd.deviceSize != 'sm') { // only adjust if device size is not small
          // determine which adjustment to make based on size in default src
          if (imgName.indexOf('400x510') != -1) {
            imgName = imgName.replace('400x510', '400x760');
            adjusted = "adjusted to 400x760."
          }
          if (imgName.indexOf('320x260') != -1) {
            imgName = imgName.replace('320x260', '320x320');
            adjusted = "adjusted to 320x320."
          }
        }else{
          adjusted = 'Small device/viewport no adjustment needed.'
        }

        // log success
        labAd.log({label: 'setSrcSize: '+ adjusted, detail: imgName, type: 'log' });

        return imgName;
			} catch (err) {
        labAd.log({label: 'setSrcSize error: ', detail: err, type: 'error', isFatal: false });
			}
		}

    function showAd(aLoadedImages) {
			try {
        if (!labAd.displayed) {
          // flag to prevent ad from displaying multiple times in the event of failure or timeout
          labAd.displayed = true;

          logTime('showAd');
          labAd.log({label: 'showAd: ', detail: aLoadedImages, type: 'log' });

          ////////////////////////////////////////////////
          // 1: Append AD Area (360x105 or 360x140) images to labAdDiv. //
          ////////////////////////////////////////////////
          aLoadedImages.forEach(function(elem) {// for each aLoadedImages el: assign CSS and behavior(s) then attach to DOM
            // add el reference to labAd.els
            labAd.els[elem.id] = elem;
            // assign common class to all
            labAd.els[elem.id].className = 'abs-' + labAd.deviceSize;
            labAd.els.labAdDiv.className = labAd.deviceSize;
            // append to labAdDiv
            labAd.els.labAdDiv.appendChild(labAd.els[elem.id]);
            // assign specific behavior/format by id
            if (elem.id === 'btnInv') { // assign click handler to invisible btn
              labAd.els[elem.id].onclick = exitClick;
            }
          });

          // HACK: Diagnostic code for Android small 360 width screens
          // get box info for labAdDiv
          var rect = labAd.els.labAdDiv.getBoundingClientRect();
          // stringify rect details and append to diagnostics p
          labAd.els.diagnostics = document.getElementById('diagnostics');
          labAd.els.diagnostics.innerHTML += '<br><br>' + JSON.stringify(rect, null, 1);
          labAd.els.diagnostics.style.height = (rect.height - 10) + 'px';
          // remove hidden class after setting innerHTML
          labAd.els.diagnostics.className = '';

          //////////////////////////
          // 2: track in mixpanel //
          //////////////////////////
          var trackObj = {
  					adCond: labAd.adCond,
  					bgEvent: labAd.selected.bgEvent,
  					dPR: labAd.dpr,
  					scenario: labAd.selected.scenario
  				};
          // add property for bg file displayed - img or video
          if (trackObj.bgEvent === 'adBgIntF') {
            trackObj.bgFile = labAd.appBg.imgID;
          } else {
            trackObj.bgFile = labAd.appBgVid.vidURL;
          }
          mixpanelTrack('imp-showAd', 'imp', trackObj);
        } else {
          var err = {message:'showAd called again.'}
          labAd.log({label: 'Display routine called after labAd.displayed === true.', detail: err, type: 'error', isFatal: false });
        }
			} catch (err) {
        labAd.log({label: 'showAd error: ', detail: err, type: 'error', isFatal: true });
			}
		}

    function showBg(sBgEvent){
      try {
        logTime('showBg');
        var trackObj = {}; // for mp tracking

        ///////////////////////////////////////////////////////////////////
        // 1: Process BG properties and fireAppEvent based on event name //
        ///////////////////////////////////////////////////////////////////
        if (sBgEvent === 'adBgIntF') {
          // set appBg baseURL - should be the same as labAd.dir
          labAd.appBg.baseURL = labAd.dir;
          // adjust DPR  for BG image
          labAd.appBg.imgID = imgDPR(labAd.appBg.imgID);
          // encode BG image name to prevent '@' from breaking app event.
          labAd.appBg.imgID = encodeURIComponent(labAd.appBg.imgID);
           // fire the app event passing updated props
          fireAppEvent('adBgIntF', labAd.appBg);
          // copy object so exact details are passed to mixpanel
          trackObj = JSON.parse(JSON.stringify(labAd.appBg));
        } else {
          // force @2x video bg every time.
          labAd.appBgVid.vidURL = labAd.appBgVid.vidURL.replace('@1x','@2x');
          // encode vidURL - because '@' is not compatible with BG app events
          labAd.appBgVid.vidURL = encodeURIComponent(labAd.appBgVid.vidURL);
          // prepend labAd.dir to vidURL
          labAd.appBgVid.vidURL = labAd.dir + labAd.appBgVid.vidURL;
           // fire the app event passing updated props
          fireAppEvent('adBgVidIntF', labAd.appBgVid);
          // copy object so exact details are passed to mixpanel
          trackObj = JSON.parse(JSON.stringify(labAd.appBgVid));
        }

        //////////////////////////
        // 2: track in mixpanel //
        //////////////////////////
        trackObj.adCond = labAd.adCond;
        trackObj.eventName = sBgEvent;

				mixpanelTrack('app-showBg-'+ sBgEvent, 'app', trackObj);

        labAd.log({label: 'showBg ', detail: sBgEvent, type: 'log' });
      } catch (err) {
        labAd.log({label: 'showBg error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function showDefault(sReason) {
			try {
        if (!labAd.displayed) {
          // flag to prevent ad from displaying multiple times in the event of failure or timeout
          labAd.displayed = true;

          logTime('showDefault');
          labAd.default.reason = sReason;
          labAd.log({label: 'showDefault: ', detail: labAd.default.reason, type: 'log' });

          // show AD Area (360x105) contents. Apply img srcs and reveal container
          labAd.els.defaultImg = document.createElement('img');
  				labAd.els.defaultImg.src = labAd.dir + imgDPR(labAd.default.img);
  				labAd.els.defaultImg.id = 'defaultImg';
  				labAd.els.defaultImg.className = 'abs-' + labAd.deviceSize;
  				labAd.els.defaultImg.alt = labAd.default.reason;
  				labAd.els.defaultImg.onclick = exitClick;
  				labAd.els.defaultImg.onload = function(){
  					// add img to main labAdDiv container and adjust className
  					labAd.els.labAdDiv.className = labAd.deviceSize;
  					labAd.els.labAdDiv.appendChild(labAd.els.defaultImg);
  				}

  				// track in mixPanel as imp-showAd
  				var trackObj = {
  					adCond: labAd.adCond,
            bgEvent: labAd.selected.bgEvent,
  					scenario: labAd.selected.scenario,
  					defaultReason: labAd.default.reason,
  					defaultImg: labAd.default.img
  				};
  				mixpanelTrack('imp-showDefault', 'imp', trackObj);
        } else {
          var err = {message:'showDefault called again.'}
          labAd.log({label: 'Display routine called after labAd.displayed === true.', detail: err, type: 'error', isFatal: false });
        }

			} catch (err) {
				// not fatal since there's no fallback for this failure.
        labAd.log({label: 'showDefault error: ', detail: err, type: 'error', isFatal: false });
			}
		}

    document.addEventListener('DOMContentLoaded', initAd, false);
    </script>
    <style>
    /* CORE CSS - DO NOT EDIT  */
      body {margin: 0;}

      #labAdDiv {
        width: 320px;
        position: relative;
        margin: 0 auto;
      }
      #labAdDiv.sm {height: 260px;}
      #labAdDiv.md, #labAdDiv.lg, #labAdDiv.xl {height: 320px;}

      /* Ad Slot Size & Position */
      .abs-sm {
        width: 320px;
        height: 260px;
        position: absolute;

      }

      .abs-md, .abs-lg, .abs-xl {
        width: 320px;
        height: 320px;
        position: absolute;

      }
      #btnInv {
        z-index: 10;
        cursor: pointer;
        /* background: rgba(255,255,255, .25); */
      }

      .hidden{opacity: 0;}
    /* END: CORE CSS - DO NOT EDIT  */

    /* Preview Mode CSS - DO NOT EDIT */
      #previewMainContainer{opacity: 0;}
      #previewAltContainer{display: none;}
    /* END: Preview Mode CSS - DO NOT EDIT */

    /* Creative-specific CSS */
			#diagnostics{
        background: rgba(4, 6, 60, 0.76);
        color: #fff;
        position: absolute;
        z-index: 3;
        /* font-size: .9em; */
        padding: 5px;
        margin: 0;
        font-family: monospace;
			}
    </style>
  </head>

  <body>
    <!-- #labAdDiv is the main container for all AD elements -->
    <div id="labAdDiv">
<!--
			<p id="diagnostics" class="hidden">CID:%ecid! - POS:%%PATTERN:pos%% <br>
        %%WIDTH%%x%%HEIGHT%%</p>
      -->
		</div>

    <!-- Container for all tracking pixels - manually placed or dynamically generated. -->
    <div id="labTracking" style="display:none;">
		</div>

    <!-- Preview Mode Structure - DO NOT EDIT -->
    <div id="previewMainContainer">
      <!-- LEFT FORM COL -->
      <div id="previewColLeft">
        <hr>
        <img id="previewFormLogo" src="" alt="IBM Watson Advertising">
        <hr>
        <p id="previewFormClientName">
          Client Name Here<br>
          Mobile App Integrated Marquee
        </p>
        <hr>
        <div id="previewFormDeviceSize">
           <input type="radio" name="deviceSize" value="lg" id="deviceLarge">
           <label for="deviceLarge">Large Device</label>
           <input type="radio" name="deviceSize" value="sm" id="deviceSmall">
           <label for="deviceSmall">Regular Device</label>
        </div>
        <hr>
        <div id="previewFormCondition">
          <div id="btnPrevCond"> < </div>
          <div id="txtCondName"></div>
          <div id="btnNextCond"> > </div>
        </div>
        <hr>
        <div id="previewFormConditionIndex"></div>
      </div>

      <!-- RIGHT AD COL  -->
      <div id="previewColRight">

        <div id="previewAppOverlay">
          <!-- previewAppOverlay = newer layout with images for device and app ui. -->
          <div id="previewDeviceToggleBtn"></div>
          <div id="previewDeviceOverlay"></div>
          <div id="previewUiOverlay"></div>
        </div>

        <div id="previewAppLayout">
          <!-- previewAppLayout (previously previewAppContainer) = older layout with colored divs representing different regions of app. -->
          <div id="previewAppHeader"></div>
          <div id="previewAppToggle"></div>
          <div id="previewAppChart"></div>
          <div id="previewAppInsight"></div>
          <div id="previewAppGradient"></div>
          <div id="previewAppNav"></div>
          <div id="previewAppCoverRight"></div>
          <div id="previewAppCoverLeft"></div>
        </div>

      <!-- End Right Column -->
      </div>
    </div>
    <div id="previewAltContainer">
      <img id="previewAltLogo" src="" alt="IBM Watson Advertising">
      <p>Please increase browser width to view creative preview form.</p>
    </div>




  </body>
</html>
